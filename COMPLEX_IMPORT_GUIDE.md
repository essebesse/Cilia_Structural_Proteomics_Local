# Protein Complex Import Guide

Complete guide for importing and visualizing multi-protein complex data (AB, ABC, ABCD, etc.) in ProtoView.

## Table of Contents
1. [Overview](#overview)
2. [Database Setup](#database-setup)
3. [Importing Complex Data](#importing-complex-data)
4. [Supported Complex Configurations](#supported-complex-configurations)
5. [Step-by-Step Example: IFT74_IFT81](#step-by-step-example-ift74_ift81)
6. [Web Interface Usage](#web-interface-usage)
7. [Troubleshooting](#troubleshooting)

---

## Overview

ProtoView now supports multi-protein complexes as baits interacting with prey proteins. This extends the original single-protein bait functionality to complexes like:

- **AB:C** - Two-protein complex (e.g., IFT74+IFT81 binding to prey)
- **ABC:D** - Three-protein complex
- **ABCD:E** - Four-protein complex
- **And more!** - Any number of proteins in the bait complex

### Key Features

****Flexible Architecture** - Supports 2, 3, 4+ protein complexes
****Chain Preservation** - Maintains AlphaFold 3 chain assignments (A, B, C, etc.)
****Per-Chain Metrics** - Stores detailed interface pLDDT data per chain
****Same Confidence Filtering** - Uses identical three-tier classification as single proteins
****Backward Compatible** - Single-protein system remains unchanged

---

## Database Setup

### Step 1: Set Database Connection

```bash
export POSTGRES_URL="postgresql://neondb_owner:npg_q2HCPRojzJ0i@ep-falling-shadow-agzy57k0-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
```

### Step 2: Create Complex Tables

Run the setup script **once** to create the necessary tables:

```bash
node db/setup_complex_tables.mjs
```

This creates:
- `protein_complexes` - Stores complex metadata (name, display name, number of proteins)
- `complex_proteins` - Junction table linking proteins to complexes (with chain IDs)
- `complex_interactions` - Interactions between complexes and prey proteins

**Output:**
```
ProtoView Complex Tables Setup
==============================

Step 1: Creating protein_complexes table...
  ✓ protein_complexes table ready

Step 2: Creating complex_proteins junction table...
  ✓ complex_proteins table ready

Step 3: Creating complex_interactions table...
  ✓ complex_interactions table ready

Step 4: Creating indexes...
  ✓ Index on complex_proteins.complex_id
  ✓ Index on complex_proteins.protein_id
  ✓ Index on complex_interactions.bait_complex_id
  ✓ Index on complex_interactions.prey_protein_id
  ✓ Index on complex_interactions.confidence
  ✓ Index on protein_complexes.complex_name

Step 5: Verifying tables...
  ✓ protein_complexes: 0 entries
  ✓ complex_proteins: 0 links
  ✓ complex_interactions: 0 interactions

✓ Setup complete!
```

---

## Importing Complex Data

### Prerequisites

Your data must be in **AF3 bait-prey JSON format** generated by `AF3_bait_prey_analysis_v3.py`:

**Required JSON structure:**
```json
{
  "analysis_type": "bait_prey_interactions_only",
  "bait_chains": "auto-detected",
  "prey_chains": "auto-detected",
  "high_confidence_predictions": [
    {
      "directory_name": "q96lb3_q8wya0_with_q9h7x7",
      "bait_chains": ["A", "B"],
      "prey_chains": ["C"],
      "iptm": 0.38,
      "contacts_pae3": 0,
      "contacts_pae6": 39,
      "mean_interface_plddt": 82.5,
      "confidence_class": "Low iPTM - Proceed with Caution",
      "per_chain_interface_plddt": {
        "A": {"mean": 85.5, "min": 81.0, "max": 87.9},
        "B": {"mean": 84.7, "min": 81.1, "max": 86.5},
        "C": {"mean": 80.2, "min": 67.0, "max": 85.0}
      }
    }
  ]
}
```

### Import Command

```bash
node db/import_complex_af3_json.mjs /path/to/AF3_bait_prey_analysis_v3.json
```

### What the Import Does

1. **Extracts Bait Proteins** - Identifies UniProt IDs from directory name (e.g., `Q96LB3_Q8WYA0`)
2. **Creates Complex Entry** - Registers the complex with a human-readable name
3. **Links Proteins** - Associates each protein with the complex and its chain ID
4. **Imports Interactions** - Stores complex-prey interactions with full metrics
5. **Filters by Confidence** - **Only imports** "Very High", "Worth Investigating", and "Low iPTM - Proceed with Caution"

### Confidence Filtering

****IMPORTED:**
- Very High Confidence
- Worth Investigating
- Low iPTM - Proceed with Caution

****SKIPPED:**
- Very Low

This is **identical to single-protein filtering** to maintain data quality.

---

## Supported Complex Configurations

The system automatically detects and supports **any complex size**:

| Complex Type | Bait Chains | Prey Chains | Example |
|--------------|-------------|-------------|---------|
| AB:C | A, B | C | IFT74 + IFT81 → prey |
| ABC:D | A, B, C | D | Three-protein complex |
| ABCD:E | A, B, C, D | E | Four-protein complex |
| AB:CD | A, B | C, D | Multiple prey (future support) |

**Chain Detection:**
- Automatically parsed from `bait_chains` and `prey_chains` arrays in JSON
- Chain IDs (A, B, C...) are preserved from AlphaFold 3 structure
- Position within complex is tracked for consistent display

---

## Step-by-Step Example: IFT74_IFT81

### Test Case Overview

**Complex:** IFT74 (Q96LB3) + IFT81 (Q8WYA0)
**Structure:** AB:C (2-protein bait, 1-protein prey)
**Data Source:** `/emcc/au14762/elo_lab/AlphaPulldown/AF3_APD/Q96LB3_Q8WYA0_IFT74_81/AF3/`

**Expected Results:**
- 14 interactions (all "Low iPTM - Proceed with Caution")
- Representative prey: IFT22, IFT27, IFT88, RABL2A, etc.

### Step 1: Import the Complex

```bash
export POSTGRES_URL="postgresql://neondb_owner:npg_q2HCPRojzJ0i@ep-falling-shadow-agzy57k0-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"

node db/import_complex_af3_json.mjs \
  /emcc/au14762/elo_lab/AlphaPulldown/AF3_APD/Q96LB3_Q8WYA0_IFT74_81/AF3/AF3_bait_prey_analysis_v3.json
```

**Expected Output:**
```
AlphaFold 3 Complex-Prey Data Importer
=====================================

Found 14 high-confidence predictions
Analysis type: bait_prey_interactions_only
Bait chains: auto-detected
Prey chains: auto-detected

Complex configuration: [A+B] : [C]
Detected 2 bait proteins: Q96LB3, Q8WYA0

Step 1: Creating/fetching bait proteins...
  ✓ Protein Q96LB3 (ID: 123)
  ✓ Protein Q8WYA0 (ID: 124)

Step 2: Creating protein complex...
  ✓ Created complex: Q96LB3 & Q8WYA0 (2 proteins)

Step 3: Linking proteins to complex...
  ✓ Linked Q96LB3 as chain A (position 0)
  ✓ Linked Q8WYA0 as chain B (position 1)

Step 4: Importing complex-prey interactions...
Filtering: Only importing Very High Confidence, Worth Investigating, Low iPTM - Proceed with Caution

  [1/14] q96lb3_q8wya0_with_q9h7x7: Low iPTM - Proceed with Caution (iPTM: 0.38, iPAE<6Å: 39)
  [2/14] q96lb3_q8wya0_with_q03395: Low iPTM - Proceed with Caution (iPTM: 0.41, iPAE<6Å: 12)
  [3/14] q96lb3_q8wya0_with_q9unt1: Low iPTM - Proceed with Caution (iPTM: 0.41, iPAE<6Å: 38)
  ...
  [14/14] q96lb3_q8wya0_with_q6q759: Low iPTM - Proceed with Caution (iPTM: 0.37, iPAE<6Å: 4)

✓ Import complete!
  Complex: Q96LB3 & Q8WYA0 (2 proteins)
  Imported: 14 interactions
  Skipped: 0 low-confidence predictions
```

### Step 2: Assign Organisms (Incremental)

```bash
node db/incremental_organism_lookup.mjs
```

This assigns organism codes (Hs:, Cr:, etc.) to any new proteins without disrupting existing data.

### Step 3: Fetch Protein Aliases

```bash
node db/fetch_aliases.mjs
```

Fetches gene names and aliases from UniProt API for new proteins.

### Step 4: Populate Gene Names

```bash
node -e "const { sql } = require('@vercel/postgres'); (async () => { const result = await sql\`UPDATE proteins p SET gene_name = pa.alias_name FROM protein_aliases pa WHERE p.id = pa.protein_id AND pa.alias_type = 'gene_name' AND p.gene_name IS NULL\`; console.log(\`Updated \${result.rowCount} proteins\`); })();"
```

Copies gene names from aliases table to proteins table for display.

### Step 5: Verify Import

Check the database to confirm successful import:

```bash
node db/check_db.mjs
```

Look for:
- New entries in `protein_complexes`
- Links in `complex_proteins`
- Interactions in `complex_interactions`

---

## Web Interface Usage

### Accessing Complexes

1. **Navigate to ProtoView**: https://ciliaaf3predictions.vercel.app/
2. **Switch to Complex Mode**:
   - In the left sidebar, select the **"Protein Complex"** radio button
3. **Select a Complex**:
   - Choose from the dropdown (e.g., "Q96LB3 & Q8WYA0 (14 interactions)")
4. **View Interactions**:
   - Network graph displays complex as grouped/clustered bait
   - Table shows complex components and prey proteins

### Complex Display Format

**Dropdown Option:**
```
Q96LB3 & Q8WYA0 (14 interactions)
```

**Complex Info Panel:**
```
Components:
IFT74 (Q96LB3) + IFT81 (Q8WYA0)
```

**Interaction Table:**

| Bait Complex | Prey | Confidence | iPTM | iPAE <3Å | iPAE <6Å | ipLDDT |
|--------------|------|------------|------|----------|----------|--------|
| **Q96LB3 & Q8WYA0**<br><small>IFT74 + IFT81</small> | IFT22 (Q9H7X7) | Low iPTM - Proceed with Caution | 0.38 | 0 | 39 | 82.5 |

### Confidence Filtering

Complex interactions use the **same confidence filters** as single proteins:
- ☑ Very High Confidence
- ☑ Worth Investigating
- ☑ Low iPTM - Proceed with Caution

Check/uncheck to filter displayed interactions.

---

## Troubleshooting

### Issue: "Table protein_complexes does not exist"

**Solution:** Run the setup script first:
```bash
node db/setup_complex_tables.mjs
```

### Issue: "Could not extract bait protein IDs from directory name"

**Problem:** Directory name doesn't contain recognizable UniProt IDs.

**Solution:** Ensure directory names follow the pattern:
- `Q96LB3_Q8WYA0_IFT74_81` (preferred)
- `q96lb3_q8wya0_with_prey` (also works)

UniProt IDs must match pattern: `[QPOAB][0-9][A-Z0-9]{4}`

### Issue: No interactions imported

**Possible Causes:**
1. **All interactions are "Very Low" confidence** - These are intentionally skipped
2. **JSON format incorrect** - Verify it's from `AF3_bait_prey_analysis_v3.py`
3. **Missing `high_confidence_predictions` key** - Check JSON structure

**Solution:** Review the JSON file and confirm confidence levels:
```bash
cat AF3_bait_prey_analysis_v3.json | grep "confidence_class"
```

### Issue: Complex not appearing in dropdown

**Possible Causes:**
1. Import failed silently
2. No interactions imported (all filtered out)
3. Frontend not fetching complexes

**Solutions:**
1. Check database:
   ```bash
   node -e "const { sql } = require('@vercel/postgres'); (async () => { const result = await sql\`SELECT * FROM protein_complexes\`; console.log(result.rows); })();"
   ```
2. Verify API endpoint works:
   ```bash
   curl https://ciliaaf3predictions.vercel.app/api/complexes
   ```
3. Check browser console for errors

### Issue: Organism codes not showing (proteins display as "null")

**Solution:** Run the post-import steps:
```bash
# Step 1: Assign organisms
node db/incremental_organism_lookup.mjs

# Step 2: Fetch aliases
node db/fetch_aliases.mjs

# Step 3: Populate gene names
node -e "const { sql } = require('@vercel/postgres'); (async () => { const result = await sql\`UPDATE proteins p SET gene_name = pa.alias_name FROM protein_aliases pa WHERE p.id = pa.protein_id AND pa.alias_type = 'gene_name' AND p.gene_name IS NULL\`; console.log(\`Updated \${result.rowCount} proteins\`); })();"
```

---

## Complete Import Workflow Template

```bash
#!/bin/bash
# Complete workflow for importing a new protein complex

# 1. Set database connection
export POSTGRES_URL="postgresql://neondb_owner:npg_q2HCPRojzJ0i@ep-falling-shadow-agzy57k0-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"

# 2. Setup tables (only needed once)
# node db/setup_complex_tables.mjs

# 3. Import complex data
node db/import_complex_af3_json.mjs \
  /path/to/your/AF3_bait_prey_analysis_v3.json

# 4. Assign organisms (incremental - safe)
node db/incremental_organism_lookup.mjs

# 5. Fetch protein aliases
node db/fetch_aliases.mjs

# 6. Populate gene names
node -e "const { sql } = require('@vercel/postgres'); (async () => { const result = await sql\`UPDATE proteins p SET gene_name = pa.alias_name FROM protein_aliases pa WHERE p.id = pa.protein_id AND pa.alias_type = 'gene_name' AND p.gene_name IS NULL\`; console.log(\`Updated \${result.rowCount} proteins\`); })();"

# 7. Verify
node db/check_db.mjs

# 8. View in web app
echo "Visit: https://ciliaaf3predictions.vercel.app/"
echo "Switch to 'Protein Complex' mode and select your complex!"
```

---

## Summary

****Database Schema** - Flexible architecture supporting 2-10+ protein complexes
****Import Script** - Automated extraction and storage with confidence filtering
****API Endpoints** - RESTful access to complex data
****Web Interface** - Dropdown selector with detailed component display
****Backward Compatible** - Single-protein functionality unchanged

**Next Steps:**
1. Import your complex data
2. View in web interface
3. Filter by confidence levels
4. Explore complex-prey interaction networks!

For questions or issues, check the troubleshooting section or review the main documentation in `CLAUDE.md`.
